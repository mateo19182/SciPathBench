{% extends "base.html" %}

{% block title %}Live Runs - SciPathBench{% endblock %}

{% block content %}
<div class="container">
    <div class="live-container">
        <h2>Live LLM Runs</h2>
        <p>Watch LLM agents attempt to solve pathfinding challenges in real-time.</p>
        
        <div class="controls">
            <div class="model-selection">
                <label for="model-input" class="label">Model (OpenRouter format):</label>
                <input type="text" id="model-input" placeholder="e.g., mistralai/ministral-8b" value="mistralai/ministral-8b">
            </div>
            <button id="start-llm-run" class="cs-btn">Start New Run</button>
        </div>
        
        <div id="active-runs" class="runs-section">
            <h3>Active Runs</h3>
            <div id="active-runs-list" class="runs-list">
                <div class="no-runs">No active runs</div>
            </div>
        </div>
        
        <div id="recent-runs" class="runs-section">
            <h3>Recent Completions</h3>
            <div id="recent-runs-list" class="runs-list">
                <div class="no-runs">No recent runs</div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let ws = null;
let clientId = 'live_' + Date.now();
let activeRuns = new Map();
let recentRuns = [];

function connectWebSocket() {
    ws = new WebSocket(`ws://localhost:8001/ws/${clientId}`);
    
    ws.onopen = function(event) {
        console.log('WebSocket connected');
    };
    
    ws.onmessage = function(event) {
        const message = JSON.parse(event.data);
        handleWebSocketMessage(message);
    };
    
    ws.onclose = function(event) {
        console.log('WebSocket disconnected');
        setTimeout(connectWebSocket, 3000);
    };
    
    ws.onerror = function(error) {
        console.error('WebSocket error:', error);
    };
}

function handleWebSocketMessage(message) {
    switch (message.type) {
        case 'llm_run_started':
            handleRunStarted(message.data);
            break;
        case 'llm_run_completed':
            handleRunCompleted(message.data);
            break;
        case 'error':
            handleError(message.data);
            break;
    }
}

function handleRunStarted(data) {
    activeRuns.set(data.run_id, {
        ...data,
        start_time: Date.now()
    });
    updateActiveRunsDisplay();
}

function handleRunCompleted(data) {
    // Move from active to recent
    if (activeRuns.has(data.run_id)) {
        const runData = activeRuns.get(data.run_id);
        activeRuns.delete(data.run_id);
        
        recentRuns.unshift({
            ...runData,
            ...data.result,
            run_data: data.run_data,
            end_time: Date.now()
        });
        
        // Keep only last 10 recent runs
        if (recentRuns.length > 10) {
            recentRuns = recentRuns.slice(0, 10);
        }
        
        updateActiveRunsDisplay();
        updateRecentRunsDisplay();
    }
}

function handleError(data) {
    alert('Error: ' + data.message);
}

function updateActiveRunsDisplay() {
    const container = document.getElementById('active-runs-list');
    
    if (activeRuns.size === 0) {
        container.innerHTML = '<div class="no-runs">No active runs</div>';
        return;
    }
    
    container.innerHTML = '';
    activeRuns.forEach((run, runId) => {
        const runElement = createActiveRunElement(run, runId);
        container.appendChild(runElement);
    });
}

function updateRecentRunsDisplay() {
    const container = document.getElementById('recent-runs-list');
    
    if (recentRuns.length === 0) {
        container.innerHTML = '<div class="no-runs">No recent runs</div>';
        return;
    }
    
    container.innerHTML = '';
    recentRuns.forEach(run => {
        const runElement = createRecentRunElement(run);
        container.appendChild(runElement);
    });
}

function createActiveRunElement(run, runId) {
    const div = document.createElement('div');
    div.className = 'run-item active-run';
    div.innerHTML = `
        <div class="run-header">
            <span class="run-id">${runId}</span>
            <span class="run-model">${run.model}</span>
            <span class="run-status running">Running</span>
        </div>
        <div class="run-details">
            <div class="run-papers">
                <span class="start-paper">${run.start_paper}</span>
                <span class="arrow">â†’</span>
                <span class="end-paper">${run.end_paper}</span>
            </div>
            <div class="run-time">
                Runtime: <span class="runtime">${formatRuntime(Date.now() - run.start_time)}</span>
            </div>
        </div>
    `;
    return div;
}

function createRecentRunElement(run) {
    const div = document.createElement('div');
    div.className = 'run-item recent-run';
    const runData = run.run_data || run.leaderboard_entry || {};
    const success = runData.success ? 'success' : 'failed';
    
    div.innerHTML = `
        <div class="run-header">
            <span class="run-model">${runData.model || 'Unknown'}</span>
            <span class="run-status ${success}">${success.toUpperCase()}</span>
            <span class="run-timestamp">${runData.timestamp || 'Unknown'}</span>
        </div>
        <div class="run-details">
            <div class="run-metrics">
                <span class="metric">Length: ${runData.path_length || 0}</span>
                <span class="metric">Optimal: ${runData.optimal_length || 0}</span>
                <span class="metric">Optimality: ${((runData.optimality || 0) * 100).toFixed(1)}%</span>
                <span class="metric">Runtime: ${formatRuntime((runData.runtime || 0) * 1000)}</span>
            </div>
        </div>
    `;
    return div;
}

function formatRuntime(milliseconds) {
    const seconds = Math.floor(milliseconds / 1000);
    const minutes = Math.floor(seconds / 60);
    
    if (minutes > 0) {
        return `${minutes}m ${seconds % 60}s`;
    } else {
        return `${seconds}s`;
    }
}



function startLLMRun() {
    const modelInput = document.getElementById('model-input');
    const selectedModel = modelInput.value.trim();
    
    if (!selectedModel) {
        alert('Please enter a model name in OpenRouter format (e.g., mistralai/ministral-8b)');
        return;
    }
    
    if (ws && ws.readyState === WebSocket.OPEN) {
        ws.send(JSON.stringify({
            type: 'start_llm_run',
            data: {
                model: selectedModel
            }
        }));
    } else {
        alert('WebSocket not connected. Please wait and try again.');
    }
}

// Update runtime display every second for active runs
setInterval(() => {
    document.querySelectorAll('.active-run .runtime').forEach(element => {
        const runItem = element.closest('.run-item');
        const runId = runItem.querySelector('.run-id').textContent;
        const run = activeRuns.get(runId);
        if (run) {
            element.textContent = formatRuntime(Date.now() - run.start_time);
        }
    });
}, 1000);

// Event listeners
document.getElementById('start-llm-run').addEventListener('click', startLLMRun);

// Initialize
connectWebSocket();
</script>
{% endblock %}